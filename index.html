<!DOCTYPE HTML>
<html>
    <head>
        <script type="text/javascript" src="jquery.min.js"></script>
        <script src="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
        <script src="jquery.tmpl.js"></script>
        <script>
            var _total=18000;      
            var _arrData=[];
            var _data='';
            /*var _drillDownArrJson=[{
                "label":"decor",
                "items":[{
                    "name":"item0",
                    "cost":"200"
                },{
                    "name":"item1",
                    "cost":"400"
                }]
            }];*/
            var _drillDownArrJson=[{
                "label":"decor",
                "items":[{
                    "name":"item0",
                    "cost":"200"
                },{
                    "name":"item1",
                    "cost":"400"
                }]
            }];   
            $(document).ready(function() { 

                function getItemsArrayForCategory(clickedCat){
                    for (var key in _drillDownArrJson){   
                        var currCat =_drillDownArrJson[key]["label"];
                        if(currCat==clickedCat){
                            return _drillDownArrJson[key];
                        }
                    }
                    return null;
                }
                function drillDown(e){
                    var clickedSection=e.dataPoint["label"];
                    var itemsArr= getItemsArrayForCategory(clickedSection);
                    // e.chart.options.title = { text: e.dataPoint.name }
                    //e.chart.render();
                    //$("#backButton").toggleClass("invisible");
                    $("#itemlist").modal("show");
                    //LIST_OF_ITEMS_BOUGHT  itemsBoughtCardId
                    $('#itemsBoughtCardId').empty();  
                    // $('#table').append($("#DRAGGABLE_ELEMENTS_TEMPLATE").tmpl(_obj));
                    $("#itemsBoughtCardId").append($("#LIST_OF_ITEMS_BOUGHT_TEMPLATE").tmpl(itemsArr));
                }
                $("#itemlist").on("shown.bs.modal",function(){

                }); 
                function isCategoryAlreadyExisting(cat){
                    var catFoungFlag=false;
                    for (var key in _arrData){   
                        var currCat =_arrData[key]["label"];
                        if(currCat==cat){
                            catFoungFlag=true;
                            break;
                        }
                    }
                    alert(catFoungFlag);
                    return catFoungFlag;
                }
                function iterateOverArrayOfJsonAndSplice(x,category){
                    for (var j=0;j<x.length;j++){
                        if(x[j]["label"]==category){
                            x.splice(j,1);
                            break;
                        }                           
                    }   
                }
                function updateArray(x,currItemCost,category){
                    var l = {
                        label:category,
                        y:(currItemCost*100/_total)  
                    }
                    x.push(l);
                }
                function convertDataToArrayOfJsonObjects(data){
                    var totalCostOfAllCat=0;
                    for (var key in data){   
                        var cat =key;
                        var cost=Number(data[key]);
                        totalCostOfAllCat+=cost;
                        var l = {
                            label:key,
                            y:(data[key]*100/_total)
                        }
                        _arrData.push(l);
                    }
                    var remaining=_total-totalCostOfAllCat;
                    iterateOverArrayOfJsonAndSplice(_arrData,"remaining");
                    updateArray(_arrData,remaining,"remaining");                    
                }

                $.ajax({
                    url: 'https://api.jsonbin.io/b/5ddb6199264e8f39a7bb91d6/latest',
                    type: 'GET',//5ddb6199264e8f39a7bb91d6                        
                    headers: {
                        "secret-key": '$2b$10$wViALK6fcTtVOJfffcaiHeVPEHlNt8KIzJhhFHdrxxmv.iE6v33x.'  
                    },
                    dataType: 'json',
                    success: function (data) {
                        _data=data;
                        convertDataToArrayOfJsonObjects(data);
                        displayChart();
                    }
                });
                function calculateCostForCategory(category,currCost){
                    var existingCost=_data[category];
                    existingCost=Number(existingCost)+Number(currCost);
                    return existingCost;
                }
                $("#submitOfItem").on("click",function(){
                    var currCost=$("#costofitem").val();
                    var category=$("#category").val();
                    var currItem=$("#itemname").val();
                    if(currCost.length>0 &&category.length>0 &&currItem.length>0){
                        $("#errormessage").hide();
                    }
                    else{
                        $("#errormessage").show();
                        return;
                    }
                    if(isCategoryAlreadyExisting(category)){
                        var cost=calculateCostForCategory(category,currCost);
                        iterateOverArrayOfJsonAndSplice(_arrData,category);                       
                        updateArray(_arrData,cost,category);                    

                    }
                    else{
                        updateArray(_arrData,cost,category);                         
                    }
                    $("#itembought").modal( "hide" );
                    displayChart();

                });
                function displayChart(){
                    var options = {
                        animationEnabled: true,
                        title: {
                            text: "Manjus quick expense tracker"
                        },
                        data: [{
                            type: "doughnut",
                            click:drillDown,
                            innerRadius: "70%",
                            showInLegend: true,
                            legendText: "{label}",
                            indexLabel: "{label}: #percent%",                           
                            dataPoints: _arrData
                        }] 
                    };
                    $("#chartContainer").CanvasJSChart(options);
                }
                $("#displayBudget").on("click",function(){
                    displayChart();

                });
            });                

        </script>
    </head>
    <body>
        <div id="chartContainer" style="height: 300px; width: 100%;"></div>
        <div style="margin-left: 5%;">
            <button type="button" class="btn btn-info" data-toggle="modal" data-target="#itembought" >Add New Item</button>
        </div>

        <!-- Modal -->
        <div class="modal fade" id="itembought" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="itembought" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="datewithstringmodalLabel">Name of you bin</h5>
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                            <span aria-hidden="true">&times;</span>
                        </button>
                    </div>
                    <div class="modal-body">
                        <div id="errormessage" style="display:none" class="alert alert-warning alert-dismissible fade show">
                            <strong>Warning!</strong> Please enter a valid value in all the required fields before proceeding.
                            <button type="button" class="close" data-dismiss="alert">&times;</button>
                        </div>
                        <form crole="form">
                            <div class="form-group">
                                <label for="costofitem" class="col-form-label">Category</label>
                                <select id="category" class="mdb-select md-form">
                                    <option value="" disabled selected>SELECT</option>
                                    <option value="furniture">Furniture</option>
                                    <option value="decor">Decor</option>
                                    <option value="appliances">Appliances</option>
                                    <option value="utensils">Utensils</option>
                                    <option value="other">Other</option>
                                </select>
                            </div>                        
                            <div class="form-group">
                                <label for="itemname" class="col-form-label">Name</label>
                                <input type="text"   id="itemname" style="margin-left: 20px">
                            </div>
                            <div class="form-group">
                                <label for="costofitem" class="col-form-label">Cost</label>
                                <input type="text"   id="costofitem" style="margin-left: 28px">
                            </div>
                        </form> 
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                        <button id="submitOfItem" type="button"  class="btn btn-primary">Submit</button>
                    </div>
                </div>

            </div>
        </div>


        <!-- Modal -->
        <div class="modal fade" id="itemlist" tabindex="-1" role="dialog" data-backdrop="static" data-keyboard="false" aria-labelledby="itemlist" aria-hidden="true">
            <div class="modal-dialog" role="document">
                <div  id="itemsBoughtCardId" class="modal-content">

                </div>

            </div>
        </div>
        <script src="https://canvasjs.com/assets/script/jquery.canvasjs.min.js"></script>

        <script id="LIST_OF_ITEMS_BOUGHT_TEMPLATE" type="text/x-jquery-tmpl">
            <div class="modal-header">
                <h5 class="modal-title" id="datewithstringmodalLabel">Items bought for ${label} are</h5>
                <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                    <span aria-hidden="true">&times;</span>
            </button>
            </div>
            <div class="modal-body">
                    <ul>                       
                             {{each items}}
                               <li>  Item name is ${name} and Cost of the item is ${cost} </li>  
                             {{/each}}                        
            </ul>

            </div>
            <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
            </div>

        </script>
    </body>
</html>